{"version":3,"file":"styler-BcJeFoA3.js","sources":["../src/ansi.ts","../src/styler.ts"],"sourcesContent":["/**\n * ANSI escape code definitions and utilities\n */\n\n// Export the core ANSI codes object for direct access\n// Core ANSI codes are now handled by the core-colors plugin\nexport const ansiCodes = {} as const\n\nexport interface AnsiCodes {\n  open: string\n  close: string\n}\n\nexport type StyleName = keyof typeof ansiCodes\n\n/**\n * Check if colors should be enabled based on environment\n */\nexport function isColorSupported(): boolean {\n  // NO_COLOR environment variable disables colors\n  if (process.env.NO_COLOR) {\n    return false\n  }\n\n  // Check for common CI environments\n  if (process.env.CI && !process.env.COLORTERM) {\n    return false\n  }\n\n  // If FORCE_COLOR is set, enable colors\n  if (process.env.FORCE_COLOR) {\n    return true\n  }\n\n  // Check if running in a TTY\n  if (typeof process !== 'undefined' && process.stdout && !process.stdout.isTTY) {\n    return false\n  }\n\n  return true\n}\n\n// Color utility functions are now handled by the color-utilities plugin","import {\r\n  type AnsiCodes,\r\n  isColorSupported,\r\n} from './ansi'\r\nimport {\r\n  handleProperty,\r\n  processText,\r\n  filterMarkerCodes,\r\n  registeredCodes,\r\n} from './registry'\r\n\r\n// Cache for proxy objects to improve performance\r\nconst proxyCache = new Map<string, any>()\r\n\r\n/**\r\n * Generate a cache key for proxy objects\r\n */\r\nfunction generateCacheKey(codes: AnsiCodes[], accumulatedText: string): string {\r\n  if (codes.length === 0) {\r\n    return `text:${accumulatedText}`\r\n  }\r\n  const codesKey = codes.map((c) => `${c.open}|${c.close}`).join(',')\r\n  return `${codesKey}|${accumulatedText}`\r\n}\r\n\r\n/**\r\n * Apply ANSI codes to text\r\n */\r\nfunction applyStyle(text: string, codes: AnsiCodes[]): string {\r\n  if (!isColorSupported() || codes.length === 0) {\r\n    return text\r\n  }\r\n\r\n  const openCodes = codes.map((c) => c.open).join('')\r\n  const closeCodes = codes\r\n    .map((c) => c.close)\r\n    .reverse()\r\n    .join('')\r\n\r\n  return `${openCodes}${text}${closeCodes}`\r\n}\r\n\r\n/**\r\n * Styler class that encapsulates the styling functionality\r\n */\r\nexport class Styler {\r\n  private codes: AnsiCodes[]\r\n  private accumulatedText: string\r\n  // private inspectCustom = Symbol.for('nodejs.util.inspect.custom')\r\n\r\n  constructor(codes: AnsiCodes[] = [], accumulatedText: string = '') {\r\n    this.codes = codes\r\n    this.accumulatedText = accumulatedText\r\n\r\n    // Initialize symbol properties directly as class properties\r\n    this.initializeSymbolProperties()\r\n  }\r\n\r\n  /**\r\n   * Initialize symbol properties for proper string conversion\r\n   */\r\n  private initializeSymbolProperties(): void {\r\n    // Add Symbol.toPrimitive for proper string conversion\r\n    (this as any)[Symbol.toPrimitive] = (hint: string) => {\r\n      if (hint === 'string' || hint === 'default') {\r\n        return this.accumulatedText\r\n      }\r\n      return this.accumulatedText\r\n    }\r\n\r\n    // Add toStringTag for better object representation\r\n    (this as any)[Symbol.toStringTag] = 'Crayon';\r\n\r\n    // Add custom inspect method for Node.js util.inspect\r\n    (this as any)[Symbol.for('nodejs.util.inspect.custom')] = () => {\r\n      return this.accumulatedText\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Convert to string representation\r\n   */\r\n  public toString(): string {\r\n    return this.accumulatedText\r\n  }\r\n\r\n  /**\r\n   * Convert to primitive value\r\n   */\r\n  public valueOf(): string {\r\n    return this.accumulatedText\r\n  }\r\n\r\n  /**\r\n   * Convert to primitive value for string conversion\r\n   */\r\n  public [Symbol.toPrimitive](hint: string): string {\r\n    if (hint === 'string' || hint === 'default') {\r\n      return this.accumulatedText\r\n    }\r\n    return this.accumulatedText\r\n  }\r\n\r\n  /**\r\n   * Main method that handles both regular calls and template literals\r\n   */\r\n  public call(...args: [string] | [TemplateStringsArray, ...unknown[]]): Styler {\r\n    // Handle template literal call\r\n    if (Array.isArray(args[0]) && 'raw' in args[0]) {\r\n      const strings = args[0] as TemplateStringsArray\r\n      const values = args.slice(1)\r\n      const text = strings.reduce(\r\n        (result, str, i) => result + str + (values[i] !== undefined ? String(values[i]) : ''),\r\n        ''\r\n      )\r\n\r\n      // Let plugins handle special mode behaviors\r\n      const pluginResult = processText(this.codes, text, this.accumulatedText)\r\n      let styledText = ''\r\n\r\n      if (pluginResult) {\r\n        styledText = pluginResult.styledText\r\n      } else {\r\n        // Fallback to default behavior - apply styles to the text (excluding markers)\r\n        styledText = applyStyle(text, filterMarkerCodes(this.codes))\r\n      }\r\n\r\n      // Return a new styler with accumulated text\r\n      return createStyler(this.codes, this.accumulatedText + styledText)\r\n    }\r\n\r\n    // Handle regular function call\r\n    const text = String(args[0] ?? '')\r\n\r\n    // Let plugins handle special mode behaviors\r\n    const pluginResult = processText(this.codes, text, this.accumulatedText)\r\n    let styledText = ''\r\n\r\n    if (pluginResult) {\r\n      styledText = pluginResult.styledText\r\n    } else {\r\n      // Fallback to default behavior - apply styles to the text (excluding markers)\r\n      styledText = applyStyle(text, filterMarkerCodes(this.codes))\r\n    }\r\n\r\n    // Return a new styler with accumulated text\r\n    return createStyler(this.codes, this.accumulatedText + styledText)\r\n  }\r\n\r\n}\r\n\r\n/**\r\n * Create a styler function with the specified ANSI codes and accumulated text\r\n * This is the main entry point for creating styled text functions\r\n */\r\nexport function createStyler(codes: AnsiCodes[] = [], accumulatedText: string = ''): any {\r\n  const cacheKey = generateCacheKey(codes, accumulatedText)\r\n\r\n  // Check cache first for performance\r\n  if (proxyCache.has(cacheKey)) {\r\n    return proxyCache.get(cacheKey)\r\n  }\r\n\r\n  // Create the main function that handles both regular calls and template literals\r\n  const stylerFunction = function (...args: [string] | [TemplateStringsArray, ...unknown[]]) {\r\n    // Handle template literal call\r\n    if (Array.isArray(args[0]) && 'raw' in args[0]) {\r\n      const strings = args[0] as TemplateStringsArray\r\n      const values = args.slice(1)\r\n      const text = strings.reduce(\r\n        (result, str, i) => result + str + (values[i] !== undefined ? String(values[i]) : ''),\r\n        ''\r\n      )\r\n\r\n      // Let plugins handle special mode behaviors\r\n      const pluginResult = processText(codes, text, accumulatedText)\r\n      let styledText = ''\r\n\r\n      if (pluginResult) {\r\n        styledText = pluginResult.styledText\r\n      } else {\r\n        // Fallback to default behavior - apply styles to the text (excluding markers)\r\n        styledText = applyStyle(text, filterMarkerCodes(codes))\r\n      }\r\n\r\n      // Return a new styler with accumulated text\r\n      return createStyler(codes, accumulatedText + styledText)\r\n    }\r\n\r\n    // Handle regular function call\r\n    const text = String(args[0] ?? '')\r\n\r\n    // Let plugins handle special mode behaviors\r\n    const pluginResult = processText(codes, text, accumulatedText)\r\n    let styledText = ''\r\n\r\n    if (pluginResult) {\r\n      styledText = pluginResult.styledText\r\n    } else {\r\n      // Fallback to default behavior - apply styles to the text (excluding markers)\r\n      styledText = applyStyle(text, filterMarkerCodes(codes))\r\n    }\r\n\r\n    // Return a new styler with accumulated text\r\n    return createStyler(codes, accumulatedText + styledText)\r\n  } as any\r\n\r\n  // Add Symbol.toStringTag for better object representation\r\n  Object.defineProperty(stylerFunction, Symbol.toStringTag, {\r\n    value: 'Crayon',\r\n    enumerable: false\r\n  })\r\n\r\n  // Create proxy to handle property access through plugins\r\n  const proxy = new Proxy(stylerFunction, {\r\n    get: (target, prop) => {\r\n      // Handle symbol properties\r\n      if (typeof prop === 'symbol') {\r\n        return target[prop]\r\n      }\r\n\r\n      // Handle built-in methods\r\n      if (prop === 'toString' || prop === 'valueOf') {\r\n        return () => accumulatedText\r\n      }\r\n\r\n      // Handle Symbol.toPrimitive\r\n      if (typeof prop === 'symbol' && prop === Symbol.toPrimitive) {\r\n        return (hint: string) => {\r\n          if (hint === 'string' || hint === 'default') {\r\n            return accumulatedText\r\n          }\r\n          return accumulatedText\r\n        }\r\n      }\r\n\r\n      // Handle Node.js util.inspect\r\n      const inspectCustom = Symbol.for('nodejs.util.inspect.custom')\r\n      if (typeof prop === 'symbol' && prop === inspectCustom) {\r\n        return () => accumulatedText\r\n      }\r\n\r\n      // Let plugins handle property access\r\n      const pluginOptions = {\r\n        createStyler,\r\n        ansiCodes: registeredCodes\r\n      }\r\n\r\n      const pluginResult = handleProperty(\r\n        target,\r\n        prop,\r\n        codes,\r\n        accumulatedText,\r\n        pluginOptions\r\n      )\r\n\r\n      if (pluginResult !== undefined) {\r\n        return pluginResult\r\n      }\r\n\r\n      // Handle registered ANSI codes\r\n      if (prop in registeredCodes) {\r\n        return createStyler([...codes, registeredCodes[prop]], accumulatedText)\r\n      }\r\n\r\n      // Property not found\r\n      return undefined\r\n    }\r\n  })\r\n\r\n  // Add custom inspect method for Node.js util.inspect\r\n  const inspectCustom = Symbol.for('nodejs.util.inspect.custom')\r\n  Object.defineProperty(proxy, inspectCustom, {\r\n    value: () => accumulatedText,\r\n    enumerable: false,\r\n    writable: true,\r\n    configurable: true\r\n  })\r\n\r\n  // Cache the proxy for performance\r\n  proxyCache.set(cacheKey, proxy)\r\n\r\n  return proxy\r\n}"],"names":["text","pluginResult","styledText","inspectCustom"],"mappings":"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"}