{"version":3,"file":"registry-TWy_tVye.js","sources":["../src/registry.ts"],"sourcesContent":["/**\r\n * Plugin registry for managing Crayon extensions\r\n */\r\nimport type { StylePlugin } from './plugins/base'\r\nimport type { AnsiCodes } from './ansi'\r\nimport type { Styler } from './styler'\r\n\r\n// Plugin storage\r\nexport let plugins: StylePlugin[] = []\r\n\r\n// Store plugins in a global variable that can be accessed by the styler\r\nif (typeof globalThis !== 'undefined') {\r\n  (globalThis as any).__CRAYON_PLUGINS__ = plugins\r\n}\r\n\r\n// Flag to track if plugins have changed\r\n\r\n// Storage for registered codes\r\nexport let registeredCodes: Record<string, AnsiCodes> = {}\r\n\r\n/** Register ANSI codes */\r\nexport function registerCodes(newCodes: Record<string, AnsiCodes>): void {\r\n  Object.assign(registeredCodes, newCodes)\r\n}\r\n\r\n/** Register a new plugin */\r\nexport function register(plugin: StylePlugin): void {\r\n  plugins.push(plugin)\r\n\r\n  // Also store in global variable\r\n  if (typeof globalThis !== 'undefined') {\r\n    (globalThis as any).__CRAYON_PLUGINS__ = plugins\r\n  }\r\n}\r\n\r\n/**\r\n * Helper function to create styler properties\r\n * This is a shared utility function used by plugins to attach properties directly to styler functions\r\n */\r\nexport const createStylerProperty = (ansiCode: AnsiCodes, options: { createStyler: Function }) => ({\r\n  get() {\r\n    return (options.createStyler as Function)([ansiCode], '')\r\n  },\r\n  enumerable: true,\r\n  configurable: true\r\n})\r\n\r\n/** Handle property access through registered plugins */\r\nexport function handleProperty(\r\n  target: Styler,\r\n  prop: string,\r\n  codes: AnsiCodes[],\r\n  accumulatedText: string,\r\n  options?: {\r\n    createStyler?: Function,\r\n    ansiCodes?: Record<string, AnsiCodes>,\r\n    pluginRegistry?: any\r\n  }\r\n): Styler | undefined {\r\n  // Quick exit if no plugins\r\n  if (plugins.length === 0) {\r\n    return undefined\r\n  }\r\n\r\n  // Quick exit if no plugins have handleProperty method\r\n  let hasHandleProperty = false\r\n  for (let i = 0; i < plugins.length; i++) {\r\n    if (plugins[i].handleProperty) {\r\n      hasHandleProperty = true\r\n      break\r\n    }\r\n  }\r\n\r\n  if (!hasHandleProperty) {\r\n    return undefined\r\n  }\r\n\r\n  // Process plugins that have handleProperty method\r\n  for (let i = 0; i < plugins.length; i++) {\r\n    const plugin = plugins[i]\r\n    if (plugin.handleProperty) {\r\n      const result = plugin.handleProperty(target, prop, codes, accumulatedText, options)\r\n      if (result !== undefined) {\r\n        return result\r\n      }\r\n    }\r\n  }\r\n  return undefined\r\n}\r\n\r\n/** Filter out marker codes that don't produce visual output */\r\nexport function filterMarkerCodes(codes: AnsiCodes[]): AnsiCodes[] {\r\n  // Quick exit if no codes or no plugins\r\n  if (codes.length === 0 || plugins.length === 0) {\r\n    return codes\r\n  }\r\n\r\n  // Quick exit if no plugins have isMarkerCode method\r\n  let hasIsMarkerCode = false\r\n  for (let i = 0; i < plugins.length; i++) {\r\n    if (plugins[i].isMarkerCode) {\r\n      hasIsMarkerCode = true\r\n      break\r\n    }\r\n  }\r\n\r\n  if (!hasIsMarkerCode) {\r\n    return codes\r\n  }\r\n\r\n  const result: AnsiCodes[] = []\r\n  for (let i = 0; i < codes.length; i++) {\r\n    const code = codes[i]\r\n    let isMarker = false\r\n    // Ask each plugin if this is a marker code\r\n    for (let j = 0; j < plugins.length; j++) {\r\n      const plugin = plugins[j]\r\n      if (plugin.isMarkerCode && plugin.isMarkerCode(code)) {\r\n        isMarker = true\r\n        break\r\n      }\r\n    }\r\n    if (!isMarker) {\r\n      result.push(code)\r\n    }\r\n  }\r\n  return result\r\n}\r\n\r\n/** Let plugins process text with special behaviors (like auto-spacing) */\r\nexport function processText(codes: AnsiCodes[], text: string, accumulatedText: string): { styledText: string } | undefined {\r\n  // Quick exit if no plugins\r\n  if (plugins.length === 0) {\r\n    return undefined\r\n  }\r\n\r\n  // Quick exit if no plugins have processText method\r\n  let hasProcessText = false\r\n  for (let i = 0; i < plugins.length; i++) {\r\n    if (plugins[i].processText) {\r\n      hasProcessText = true\r\n      break\r\n    }\r\n  }\r\n\r\n  if (!hasProcessText) {\r\n    return undefined\r\n  }\r\n\r\n  // Let each plugin process the text if they have a processText method\r\n  for (let i = 0; i < plugins.length; i++) {\r\n    const plugin = plugins[i]\r\n    if (plugin.processText) {\r\n      const result = plugin.processText(codes, text, accumulatedText, filterMarkerCodes)\r\n      if (result !== undefined) {\r\n        return result\r\n      }\r\n    }\r\n  }\r\n  return undefined\r\n}"],"names":[],"mappings":"AAQO,IAAI,UAAyB,CAAA;AAGpC,IAAI,OAAO,eAAe,aAAa;AACpC,aAAmB,qBAAqB;AAC3C;AAKO,IAAI,kBAA6C,CAAA;AAGjD,SAAS,cAAc,UAA2C;AACvE,SAAO,OAAO,iBAAiB,QAAQ;AACzC;AAGO,SAAS,SAAS,QAA2B;AAClD,UAAQ,KAAK,MAAM;AAGnB,MAAI,OAAO,eAAe,aAAa;AACpC,eAAmB,qBAAqB;AAAA,EAC3C;AACF;AAMO,MAAM,uBAAuB,CAAC,UAAqB,aAAyC;AAAA,EACjG,MAAM;AACJ,WAAQ,QAAQ,aAA0B,CAAC,QAAQ,GAAG,EAAE;AAAA,EAC1D;AAAA,EACA,YAAY;AAAA,EACZ,cAAc;AAChB;AAGO,SAAS,eACd,QACA,MACA,OACA,iBACA,SAKoB;AAEpB,MAAI,QAAQ,WAAW,GAAG;AACxB,WAAO;AAAA,EACT;AAGA,MAAI,oBAAoB;AACxB,WAAS,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,QAAI,QAAQ,CAAC,EAAE,gBAAgB;AAC7B,0BAAoB;AACpB;AAAA,IACF;AAAA,EACF;AAEA,MAAI,CAAC,mBAAmB;AACtB,WAAO;AAAA,EACT;AAGA,WAAS,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,UAAM,SAAS,QAAQ,CAAC;AACxB,QAAI,OAAO,gBAAgB;AACzB,YAAM,SAAS,OAAO,eAAe,QAAQ,MAAM,OAAO,iBAAiB,OAAO;AAClF,UAAI,WAAW,QAAW;AACxB,eAAO;AAAA,MACT;AAAA,IACF;AAAA,EACF;AACA,SAAO;AACT;AAGO,SAAS,kBAAkB,OAAiC;AAEjE,MAAI,MAAM,WAAW,KAAK,QAAQ,WAAW,GAAG;AAC9C,WAAO;AAAA,EACT;AAGA,MAAI,kBAAkB;AACtB,WAAS,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,QAAI,QAAQ,CAAC,EAAE,cAAc;AAC3B,wBAAkB;AAClB;AAAA,IACF;AAAA,EACF;AAEA,MAAI,CAAC,iBAAiB;AACpB,WAAO;AAAA,EACT;AAEA,QAAM,SAAsB,CAAA;AAC5B,WAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,UAAM,OAAO,MAAM,CAAC;AACpB,QAAI,WAAW;AAEf,aAAS,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,YAAM,SAAS,QAAQ,CAAC;AACxB,UAAI,OAAO,gBAAgB,OAAO,aAAa,IAAI,GAAG;AACpD,mBAAW;AACX;AAAA,MACF;AAAA,IACF;AACA,QAAI,CAAC,UAAU;AACb,aAAO,KAAK,IAAI;AAAA,IAClB;AAAA,EACF;AACA,SAAO;AACT;AAGO,SAAS,YAAY,OAAoB,MAAc,iBAA6D;AAEzH,MAAI,QAAQ,WAAW,GAAG;AACxB,WAAO;AAAA,EACT;AAGA,MAAI,iBAAiB;AACrB,WAAS,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,QAAI,QAAQ,CAAC,EAAE,aAAa;AAC1B,uBAAiB;AACjB;AAAA,IACF;AAAA,EACF;AAEA,MAAI,CAAC,gBAAgB;AACnB,WAAO;AAAA,EACT;AAGA,WAAS,IAAI,GAAG,IAAI,QAAQ,QAAQ,KAAK;AACvC,UAAM,SAAS,QAAQ,CAAC;AACxB,QAAI,OAAO,aAAa;AACtB,YAAM,SAAS,OAAO,YAAY,OAAO,MAAM,iBAAiB,iBAAiB;AACjF,UAAI,WAAW,QAAW;AACxB,eAAO;AAAA,MACT;AAAA,IACF;AAAA,EACF;AACA,SAAO;AACT;"}